---
stages:
  - test
  - deploy

molecule:
  stage: test
  tags:
    - hephy
  image: gitlab-registry.cern.ch/hephyvienna/docker/centos7-py36amd:latest
  variables:
    ROLE: hephyvienna.frontiersquid
  before_script:
    - ln -s $CI_PROJECT_NAME ../$ROLE
  script:
    - docker --version
    - python --version
    - ansible --version
    - molecule --version
    - molecule test
    - junit2html default_junit.xml default_junit.html
  artifacts:
    reports:
      junit: default_junit.xml
    paths:
      - default_junit.xml
      - default_junit.html

galaxy:
  stage: deploy
  image: gitlab-registry.cern.ch/hephyvienna/docker/centos7-py36amd:latest
  script:
    - ansible-galaxy login --github-token $GITHUB_TOKEN_FOR_GALAXY
    - ansible-galaxy import hephyvienna ansible-role-frontiersquid
